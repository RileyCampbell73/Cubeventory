<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>

  <!-- Font Awesome JS -->
  <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js"
    integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ"
    crossorigin="anonymous"></script>
  <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js"
    integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY"
    crossorigin="anonymous"></script>

  <!-- Collapsable sidebar found here https://bootstrapious.com/p/bootstrap-sidebar -->

  <link rel="stylesheet" href="Cubevintory.css">
  <script src="js/Equipment.js"></script>
  <script src="js/GridLogic.js"></script>
  <script src="js/ItemSpawner.js"></script>
  <script src="js/AutofillCombobox.js"></script>

  <link rel="icon" type="image/x-icon" href="./cube-3d.png" />

</head>

<body>

  <div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar">

      <div id="dismiss">
        <i class="fas fa-arrow-left"></i>
      </div>

      <div class="sidebar-header">
        <h3>Cubeventory</h3>
      </div>

      <ul class="list-unstyled components">
        <li>
          <div>
            <input type="checkbox" id="EncumbranceRule" name="EncumbranceRule" value="" checked>
            <label for="EncumbranceRule">Use Encumbrance Rule</label>
          </div>
        </li>
        <li>
          <div>
            <a onclick="SaveInventory()">Save</a>
            <!-- <input type="button" onclick="SaveInventory()" value="Save"> -->
          </div>
        </li>
        <li>
          <div>
            <input type="file" id="saveUploadFile" accept=".json" style="display: none;">
            <a onclick="document.getElementById('saveUploadFile').click();">Load</a>
            <!-- <input type="button" onclick="uploadSaveFile()" value="Load"> -->
          </div>
        </li>
        <li>
          <div>
            <a data-toggle="modal" data-target="#helpModal">Help</a>
          </div>
        </li>
      </ul>
    </nav>

    <!-- Page Content -->
    <div id="content">

      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">

          <button type="button" id="sidebarCollapse" class="btn btn-info">
            <i class="fas fa-align-left"></i>
          </button>

          <h1>Cubeventory</h1>
          <div>
            <label>Character Name</label>
            <input type="text" id="CharacterName" name="CharacterName">
          </div>
          <div>
            <label>Strength</label>
            <input type="number" id="CharacterStrength" name="CharacterStrength" value="10" min="1" max="20">
          </div>
          <div>
            <label>Spawn Item:</label>
            <select id="EquipmentComboBox"></select>
          </div>
        </div>
      </nav>
    </div>
    <!-- Dark Overlay element -->
    <div class="overlay"></div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Cubeventory Help</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h4>What is Cubeventory?</h4>
            <span>Cubeventory is a helpful Dungeons and Dragons 5th Edition tool to help track players inventory and encumberance without all the math that comes with it. The idea comes from <a style="color: #007bff; background-color: transparent;" href="https://www.youtube.com/@zeebashew">Zee Bashew</a> and his video on the topic (embeded below).</span>

            <h4>Controls</h4>
            <span>Spawned items with appear in the area on the right. They can be moves and dragged. Right-clicking an item gives options to rotate, flip, or delete. you can save your inventory with the button in the sidebar. These save files can be loaded back in on returning.</span>

            <h4>Zee's video</h4>
            <iframe src="https://www.youtube.com/embed/koKL1wSRLpk" title="Animated Keg: Encumbrance in 5E Dnd(an episode from 5 years finally released today)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="container" style="padding-top: 120px;"></div>

  <div id="menu">
    <div>
      <button id="rotate-button">Rotate</button>
      <button id="flip-button">Flip</button>
      <button id="delete-button">Delete</button>
    </div>
  </div>
</body>

<script>

  //TODO

  //spawn items from PHB
  //  how to handle multiples?
  //    Put dropdown next to it, set to 1 everytime an item is picked?
  //    add duplicate button to right click

  //need to get magic items into dropdown

  //text issues
  //  text rotation & flipping
  //    check item shapes rotation to change the X or Y
  //      if 0-180 change X, otherwise change Y

  //Grid size slider
  //  have it work on increments of 10 between 30-80
  //  add this to save file.

  //Sidebar Links section
  //  add Konva contribute widget into sidebar
  //  Ko-fi link?
  //  Need favicon
  //    DONE
  //    CREDIT:
  //      <a href="https://www.flaticon.com/free-icons/cluster" title="cluster icons">Cluster icons created by samlakodad - Flaticon</a>
  //  DnD API
  
  //tidy code up
  //  move JS on this file, into other(s)
  //  Move complex item shapes to their own file
  //  DnD Json can be included as raw - without parsing?

  // Description on google

  //BUGS

  //Collision is removed when interacting with a different shape.
  //  eg, two objects collide and turn red, move third not touching either and the og two are now fine.
  //  change who/where gets their 'isColliding' set false

  //Dashes in items are misaligned

  //FUTURE

  //have some other graphic to tell when something is colliding? - May wanna use red colour. 
  //  Yeah use an image or something.
  //    image turned out to be dead end
  //    For now, we store the intended colour to be reverted to. Want a different solution.

  //Make grid size dependant on screen size?
  //  use screen size to determine the stage size and go from there?
  //  Need to figure out text before something like this.

  //Save feature
  //  throw save into cookie? 
  //    Will need to add clear / new button with a confirm

  //control to add generic item
  //  Maybe this works better with edit function?

  //Ability to switch to only generic shapes

  //Coin weight

  //edit items
  //  name, desc, weight(?), Note
  //  maybe clicking an item shows its detail in a side panel / this edit screen
  //  Set Equipped and show that visually

  //Custom Items

  //Bag of Holding and other tools to aid in Encumberance
  //  Like a mule or horse.


  var GUIDELINE_OFFSET = 10;
  var GRID_PADDING = 80;
  var GRID_SIZE = 60;

  var strength = 10;

  var width = (15 * GRID_SIZE) + GRID_PADDING + 500; //500 is for extra room for spawning items and controls
  var height = (20 * GRID_SIZE) + GRID_PADDING; // 20 is max strength

  var stage;
  var Itemlayer;
  var EquipmentJSON;

  $(document).ready(function () {

    document.title = 'Cubeventory';

    // first we need to create a stage
    stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height,
    });

    strength = $('#CharacterStrength')[0].value;

    var gridLayer = createGridLayer(strength, true)
    stage.add(gridLayer);
    stage.draw();

    // create layer for shapes
    Itemlayer = new Konva.Layer();
    // add the layer to the stage
    stage.add(Itemlayer);

    InitializeMenu();
    InitializeCollisionSnapping()

    EquipmentJSON = JSON.parse(EquipmentJSONRAW);


    $('#EquipmentComboBox').append($('<option>', {
      value: '',
      text: ''
    }));

    //loop through and create html Options for all
    for (let i = 0; i < EquipmentJSON.length; i++) {
      $('#EquipmentComboBox').append($('<option>', {
        value: JSON.stringify(EquipmentJSON[i]),
        text: EquipmentJSON[i].name
      }));
    }

    initializeItemCombobox()

    $('#EncumbranceRule').change(function () {
      //remove old grid layer
      gridLayer.destroy()
      gridLayer = createGridLayer(strength, this.checked)

      //redraw
      stage.add(gridLayer);
      gridLayer.moveToBottom();
    });

    $('#CharacterStrength').change(function () {
      strength = $('#CharacterStrength')[0].value;

      gridLayer.destroy()
      gridLayer = createGridLayer(strength, $('#EncumbranceRule')[0].checked)

      //redraw
      stage.add(gridLayer);
      gridLayer.moveToBottom();
    });

    //SIDEBAR
    $('#dismiss, .overlay').on('click', function () {
      // hide sidebar
      $('#sidebar').removeClass('active');
      // hide overlay
      $('.overlay').removeClass('active');
    });

    $('#sidebarCollapse').on('click', function () {
      // open sidebar
      $('#sidebar').addClass('active');
      // fade in the overlay
      $('.overlay').addClass('active');
      $('.collapse.in').toggleClass('in');
      $('a[aria-expanded=true]').attr('aria-expanded', 'false');
    });

    $('#CharacterName').on("focusout", function () {
      document.title = this.value + "'s Cubeventory";
    });

    $('#saveUploadFile').on("change", function () {
      uploadSaveFile();
    });

  });

  function SaveInventory() {

    var name = $('#CharacterName')[0].value

    var saveFile = {
      name: $('#CharacterName')[0].value,
      strength: strength,
      encumbranceRule: $('#EncumbranceRule')[0].checked,
      items: Itemlayer.toJSON()
    }

    var saveJSON = JSON.stringify(saveFile);

    const file = new File([saveJSON], name + ' cubeventory.json')
    const link = document.createElement('a')
    const url = URL.createObjectURL(file)

    link.href = url
    link.download = file.name
    document.body.appendChild(link)
    link.click()

    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
  }

  function uploadSaveFile() {
    var fileInput = $('#saveUploadFile')[0];
    if (!fileInput.value.length) return;

    // Create a new FileReader() object
    let reader = new FileReader();

    // Setup the callback event to run when the file is read
    reader.onload = LoadSaveFile;

    // Read the file
    reader.readAsText(fileInput.files[0]);

  }

  function LoadSaveFile(event) {
    let str = event.target.result;
    let json = JSON.parse(str);

    //update fields with save data
    $('#CharacterName')[0].value = json.name

    $('#CharacterStrength')[0].value = json.strength
    $('#CharacterStrength')[0].dispatchEvent(new Event('change'))

    $('#EncumbranceRule')[0].checked = json.encumbranceRule
    $('#EncumbranceRule')[0].dispatchEvent(new Event('change'))

    //create layer from save file
    Itemlayer.destroy()
    Itemlayer = Konva.Node.create(json.items);
    stage.add(Itemlayer);
    InitializeMenu();
    InitializeCollisionSnapping()
  }



</script>

<style>

</style>