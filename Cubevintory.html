<head>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
  <script src="https://unpkg.com/konva@9/konva.min.js"></script>
  <script src="js/Equipment.js"></script>
  <script src="js/GridLogic.js"></script>
  <script src="js/ItemSpawner.js"></script>
  <script src="js/AutofillCombobox.js"></script>
  

</head>

<body>
  <div class="ui-widget" style="padding-left: 1300;">

    <label>Character Name</label>
    <input type="text" id="CharacterName" name="CharacterName">
    <br/>

    <label>Strength</label>
    <input type="number" id="CharacterStrength" name="CharacterStrength" value="10" min="1" max="20">
    <br/>

    <label>Use Encumbrance Rule</label>
    <input type="checkbox" id="EncumbranceRule" name="EncumbranceRule" value="" >

    <br/>
    <input type="button" onclick="SaveInventory()" value="Save">
    <br/>
    <input type="file" id="saveUploadFile" accept=".json">
    <input type="button" onclick="uploadSaveFile()" value="Load">

      <br />
      <label>Spawn Item:</label>
    <select id="EquipmentComboBox"></select>
  </div>

  <div id="container"></div>

  <div id="menu">
    <div>
      <button id="rotate-button">Rotate</button>
      <button id="flip-button">Flip</button>
      <button id="delete-button">Delete</button>
    </div>
  </div>
</body>

<script>

  //TODO

  //have some other graphic to tell when something is colliding? - May wanna use red colour. 
  //  Yeah use an image or something.
  //    image turned out to be dead end
  //    For now, we store the intended colour to be reverted to. Want a different solution.

  //change cube physical size. too large?
  //  currently set to 80
  //  I think this is too big - bump down to 60
  //  Made grid size dependant on screen size?
  //    use screen size to determine the stage size and go from there?
  //    Need to figure out text before something like this.

  //spawn items from PHB
  //  WIP:
  //    Want combobox to clear once something is made?
  //    add manual add button for multiples?

  //refactor colours
  //  use a range of the same colour and get one randomly
  //  change to rgb and random those values

  //text overflow issue
  //  Refactor creating text while we're at it.

  //Save feature
  //  Just saves items and their locations into json. Let them save their own files and upload them on return
  //  throw save into cookie? 
  //    Will need to add clear / new button

  //implement sidebar? Bootstap may have one
  // how many controls do we need
  //    Character name
  //    Character Strength
  //    Rules type
  //    item spawner
  //    save button
  //    load button
  //    clear button
  //    Control to change shapes to all generic


  //Host it


  //BUGS

  //Collision is removed when interacting with a different shape.
  //  eg, two objects collide and turn red, move third not touching either and the og two are now fine.
  //  change who/where gets their 'isColliding' set false


  //FUTURE

  //Coin weight
  //edit items
  //  name, desc, weight(?), Note
  //  maybe clicking an item shows its detail in a side panel / this edit screen
  //Custom Items
  //Bag of Holding and other tools to aid in Encumberance
  //  Like a mule or horse.


  var GUIDELINE_OFFSET = 10;
  var GRID_PADDING = 80;
  var GRID_SIZE = 80;

  var strength = 10;

  var width = (15 * GRID_SIZE) + GRID_PADDING + 500; //500 is for extra room for spawning itemas and controls
  var height = (20 * GRID_SIZE) + GRID_PADDING; // 20 is max strength

  var stage;
  var Itemlayer;
  var EquipmentJSON;

  $(document).ready(function () 
  {

    // first we need to create a stage
    stage = new Konva.Stage({
      container: 'container',
      width: width,
      height: height,
    });

    strength = $('#CharacterStrength')[0].value;

    var gridLayer = createGridLayer(strength, false)
    stage.add(gridLayer);
    stage.draw();

    // create layer for shapes
    Itemlayer = new Konva.Layer();
    // add the layer to the stage
    stage.add(Itemlayer);

    InitializeMenu();
    InitializeCollisionSnapping()

    EquipmentJSON = JSON.parse(EquipmentJSONRAW);


    $('#EquipmentComboBox').append($('<option>', {
      value: '',
      text: ''
    }));

    //loop through and create html Options for all
    for (let i = 0; i < EquipmentJSON.length; i++) {
      $('#EquipmentComboBox').append($('<option>', {
        value: JSON.stringify(EquipmentJSON[i]),
        text: EquipmentJSON[i].name
      }));
    }

    initializeItemCombobox()

    $('#EncumbranceRule').change(function () {
      //remove old grid layer
      gridLayer.destroy()
      gridLayer = createGridLayer(strength, this.checked)
      
      //redraw
      stage.add(gridLayer);
      gridLayer.moveToBottom();
    });

    $('#CharacterStrength').change(function(){
      strength = $('#CharacterStrength')[0].value;
      
      gridLayer.destroy()
      gridLayer = createGridLayer(strength, this.checked)
      
      //redraw
      stage.add(gridLayer);
      gridLayer.moveToBottom();
    });

  });

  function SaveInventory()
  {

    var saveFile = {
      name: $('#CharacterName')[0].value,
      strength: strength,
      encumbranceRule: $('#EncumbranceRule')[0].checked,
      items: Itemlayer.toJSON()
    }

    var saveJSON = JSON.stringify(saveFile);

    const file = new File([saveJSON], 'save.json')
    const link = document.createElement('a')
    const url = URL.createObjectURL(file)

    link.href = url
    link.download = file.name
    document.body.appendChild(link)
    link.click()

    document.body.removeChild(link)
    window.URL.revokeObjectURL(url)
  }

  function uploadSaveFile(){
    var fileInput = $('#saveUploadFile')[0];
    if (!fileInput.value.length) return;

    // Create a new FileReader() object
	  let reader = new FileReader();

    // Setup the callback event to run when the file is read
	  reader.onload = LoadSaveFile;

    // Read the file
	  reader.readAsText(fileInput.files[0]);

  }

  function LoadSaveFile(event)
  {
    let str = event.target.result;
	  let json = JSON.parse(str);

    //update fields with save data
    $('#CharacterName')[0].value = json.name

    $('#CharacterStrength')[0].value = json.strength
    $('#CharacterStrength')[0].dispatchEvent(new Event('change'))
    
    $('#EncumbranceRule')[0].checked = json.encumbranceRule
    $('#EncumbranceRule')[0].dispatchEvent(new Event('change'))

    //create layer from save file
    Itemlayer.destroy()
    Itemlayer = Konva.Node.create(json.items);
    stage.add(Itemlayer);
    InitializeMenu();
    InitializeCollisionSnapping()
  }



</script>

<style>
  /* body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: #f0f0f0;
    } */

  #menu {
    display: none;
    position: absolute;
    width: 60px;
    background-color: white;
    box-shadow: 0 0 5px grey;
    border-radius: 3px;
  }

  #menu button {
    width: 100%;
    background-color: white;
    border: none;
    margin: 0;
    padding: 10px;
  }

  #menu button:hover {
    background-color: lightgray;
  }

  .ui-autocomplete {
    max-height: 500px;
    overflow-y: auto;
    /* prevent horizontal scrollbar */
    overflow-x: hidden;
  }
</style>